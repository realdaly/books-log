(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,43881,e=>{"use strict";let r=(0,e.i(75254).default)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);e.s(["Loader2",()=>r],43881)},76580,e=>{"use strict";var r=e.i(43476),t=e.i(71645),s=e.i(45438),a=e.i(44050),n=e.i(99786),o=e.i(12046),l=e.i(43881),d=e.i(7233);function i(){let[e,i]=(0,t.useState)([]),[c,u]=(0,t.useState)(!0),[m,b]=(0,t.useState)(""),[p,x]=(0,t.useState)(""),[g,_]=(0,t.useState)(!1),[h,f]=(0,t.useState)({title:"",notes:"",total_printed:"0",sent_to_institution:"0",qom_sold_manual:"0",qom_gifted_manual:"0",qom_pending_manual:"0",loss_manual:"0",unit_price:"0"}),j=(0,t.useCallback)(async()=>{try{u(!0);let e=await (0,s.getDb)(),r=await e.select("SELECT publisher_name FROM config ORDER BY id DESC LIMIT 1");r.length>0&&x(r[0].publisher_name);let t=await e.select(`
        SELECT 
          b.id, 
          b.title,
          COALESCE(b.total_printed, 0) as total_printed,
          COALESCE(b.sent_to_institution, 0) as sent_to_institution,
          COALESCE(b.qom_sold_manual, 0) as qom_sold_manual,
          COALESCE(b.qom_gifted_manual, 0) as qom_gifted_manual,
          COALESCE(b.qom_pending_manual, 0) as qom_pending_manual,
          COALESCE(b.loss_manual, 0) as loss_manual,

          -- Institution Aggregates (Transactions)
          COALESCE(sales.sold_qty, 0) as sold_inst,
          COALESCE(gifts.gifted_qty, 0) as gifted_inst,
          COALESCE(loans.loaned_qty, 0) as loaned_inst,
          COALESCE(loss.loss_qty, 0) as loss_inst,
          COALESCE(pending.pending_qty, 0) as pending_inst

        FROM book b
        LEFT JOIN vw_book_sales_qty sales ON sales.book_id = b.id AND sales.branch_id = (SELECT id FROM branch WHERE key='institution')
        LEFT JOIN vw_book_gifts_qty gifts ON gifts.book_id = b.id AND gifts.branch_id = (SELECT id FROM branch WHERE key='institution')
        LEFT JOIN vw_book_loans_qty loans ON loans.book_id = b.id AND loans.branch_id = (SELECT id FROM branch WHERE key='institution')
        LEFT JOIN vw_book_loss_qty loss ON loss.book_id = b.id AND loss.branch_id = (SELECT id FROM branch WHERE key='institution')
        LEFT JOIN vw_book_pending_sales_qty pending ON pending.book_id = b.id AND pending.branch_id = (SELECT id FROM branch WHERE key='institution')
        ORDER BY b.title ASC
      `);i(t)}catch(e){console.error("Failed to load inventory:",e)}finally{u(!1)}},[]);(0,t.useEffect)(()=>{j()},[j]);let N=async e=>{e.preventDefault();try{let e=await (0,s.getDb)(),{title:r,notes:t,total_printed:a,sent_to_institution:n,qom_sold_manual:o,qom_gifted_manual:l,qom_pending_manual:d,loss_manual:i,unit_price:c}=h,u=Number(a)||0,m=Number(n)||0,b=Number(o)||0,p=Number(l)||0,x=Number(d)||0,g=Number(i)||0,f=Number(c)||0;for(let s of r.split("\n").map(e=>e.trim()).filter(e=>""!==e))await e.execute(`
                    INSERT INTO book (title, notes, total_printed, sent_to_institution, qom_sold_manual, qom_gifted_manual, qom_pending_manual, loss_manual, unit_price) 
                    VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
                `,[s,t,u,m,b,p,x,g,f]);_(!1),y(),j()}catch(e){console.error(e),alert("Error saving: "+(e.message||String(e)))}},y=()=>{f({title:"",notes:"",total_printed:"0",sent_to_institution:"0",qom_sold_manual:"0",qom_gifted_manual:"0",qom_pending_manual:"0",loss_manual:"0",unit_price:"0"})},v=async(e,r,t)=>{let a=parseInt(t)||0;i(t=>t.map(t=>t.id===e?{...t,[r]:a}:t));try{let t=await (0,s.getDb)();await t.execute(`UPDATE book SET ${r} = $1 WHERE id = $2`,[a,e])}catch(e){console.error("Update failed",e),j()}},E=e.filter(e=>(0,a.normalizeArabic)(e.title).includes((0,a.normalizeArabic)(m)));return c&&0===e.length?(0,r.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,r.jsx)(l.Loader2,{className:"animate-spin text-secondary",size:48})}):(0,r.jsxs)("div",{className:"space-y-6 h-full flex flex-col",children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h1",{className:"text-3xl font-black text-primary mb-1",children:["جرد اصدارات ",p||"المؤسسة"]}),(0,r.jsx)("p",{className:"text-primary/70 text-sm",children:"نظرة عامة على المخزون وحالة التوزيع"})]}),(0,r.jsxs)("div",{className:"flex gap-3 w-full md:w-auto",children:[(0,r.jsx)(n.Input,{placeholder:"بحث عن كتاب...",value:m,onChange:e=>b(e.target.value),className:"w-full md:w-80"}),(0,r.jsxs)(n.Button,{onClick:()=>{y(),_(!0)},children:[(0,r.jsx)(d.Plus,{size:20}),(0,r.jsx)("span",{children:"إضافة كتاب"})]})]})]}),(0,r.jsx)(n.Card,{className:"flex-1 overflow-hidden p-0 border-0 shadow-2xl bg-white/40",children:(0,r.jsxs)("div",{className:"h-full overflow-auto",children:[(0,r.jsxs)("table",{className:"w-full text-right text-sm border-collapse border-b border-border",children:[(0,r.jsx)("thead",{className:"bg-primary text-primary-foreground sticky top-0 z-10 shadow-md",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-4 min-w-[220px] rounded-tr-lg",children:"اسم الكتاب"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"العدد الكلي المطبوع"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"العدد المرسل للمؤسسة من قم"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"المتبقي داخل المؤسسة"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"طور البيع"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"عدد المباع من الكتاب"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"عدد المهدى من الكتاب"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"عدد المستعار من الكتاب"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10",children:"عدد المفقود"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10 bg-black/20",children:"المتبقي في فرع قم"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10 bg-black/20",children:"مباع من فرع قم"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10 bg-black/20",children:"مهدى من فرع قم"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 border-r border-primary-foreground/10 bg-black/20 text-xs",children:"طور البيع (فرع قم)"}),(0,r.jsx)("th",{className:"p-4 text-center w-28 font-black text-white rounded-tl-lg bg-black/40 border-r border-primary-foreground/10",children:"مجموع المتبقي"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-border",children:E.map(e=>{let t=e.sent_to_institution-e.sold_inst-e.gifted_inst-e.loaned_inst-e.loss_inst-e.pending_inst-e.loss_manual,s=(e.total_printed||0)-e.sent_to_institution-e.qom_sold_manual-e.qom_gifted_manual-e.qom_pending_manual;return(0,r.jsxs)("tr",{className:"odd:bg-muted/30 even:bg-white hover:bg-primary/5 transition-colors group",children:[(0,r.jsx)("td",{className:"p-3 font-bold text-foreground border-l border-border/50",children:e.title}),(0,r.jsx)("td",{className:"p-2 text-center border-l border-border/50",children:(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all font-medium text-foreground",defaultValue:e.total_printed,onBlur:r=>v(e.id,"total_printed",r.target.value),onFocus:e=>e.target.select()})}),(0,r.jsx)("td",{className:"p-2 text-center border-l border-border/50",children:(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all font-medium text-foreground",defaultValue:e.sent_to_institution,onBlur:r=>v(e.id,"sent_to_institution",r.target.value),onFocus:e=>e.target.select()})}),(0,r.jsx)("td",{className:"p-3 text-center font-bold text-primary border-l border-border/50",children:t}),(0,r.jsx)("td",{className:"p-3 text-center text-foreground border-l border-border/50",children:e.pending_inst||"-"}),(0,r.jsx)("td",{className:"p-3 text-center text-foreground border-l border-border/50",children:e.sold_inst}),(0,r.jsx)("td",{className:"p-3 text-center text-foreground border-l border-border/50",children:e.gifted_inst}),(0,r.jsx)("td",{className:"p-3 text-center text-foreground border-l border-border/50",children:e.loaned_inst}),(0,r.jsxs)("td",{className:"p-2 text-center border-l border-border/50",children:[(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all font-medium text-foreground",defaultValue:e.loss_manual,onBlur:r=>v(e.id,"loss_manual",r.target.value),onFocus:e=>e.target.select()}),e.loss_inst>0&&(0,r.jsxs)("div",{className:"text-[10px] text-red-500 font-bold mt-0.5",children:["+",e.loss_inst," (ترانزكشن)"]})]}),(0,r.jsx)("td",{className:"p-3 text-center font-bold text-foreground border-l border-border/50",children:s}),(0,r.jsx)("td",{className:"p-2 text-center border-l border-border/50",children:(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all font-medium text-foreground",defaultValue:e.qom_sold_manual,onBlur:r=>v(e.id,"qom_sold_manual",r.target.value),onFocus:e=>e.target.select()})}),(0,r.jsx)("td",{className:"p-2 text-center border-l border-border/50",children:(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all font-medium text-foreground",defaultValue:e.qom_gifted_manual,onBlur:r=>v(e.id,"qom_gifted_manual",r.target.value),onFocus:e=>e.target.select()})}),(0,r.jsx)("td",{className:"p-2 text-center border-l border-border/50",children:(0,r.jsx)("input",{type:"number",className:"w-20 p-1.5 text-center bg-transparent border border-transparent hover:border-input rounded-lg focus:bg-white focus:border-primary focus:ring-1 focus:ring-primary transition-all font-medium text-foreground",defaultValue:e.qom_pending_manual,onBlur:r=>v(e.id,"qom_pending_manual",r.target.value),onFocus:e=>e.target.select()})}),(0,r.jsx)("td",{className:"p-3 text-center font-black text-lg text-primary bg-black/[0.05] group-hover:bg-primary/20 transition-colors border-l border-border/50",children:t+s})]},e.id)})})]}),0===E.length&&(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 text-primary/60",children:[(0,r.jsx)("p",{className:"text-xl font-bold",children:"لا توجد بيانات"}),(0,r.jsx)(n.Button,{variant:"secondary",className:"mt-8 text-primary",onClick:()=>{y(),_(!0)},children:"أضف كتاباً جديداً"})]})]})}),(0,r.jsx)(o.Modal,{isOpen:g,onClose:()=>_(!1),title:"إضافة كتاب جديد",children:(0,r.jsxs)("form",{onSubmit:N,className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"col-span-2",children:[(0,r.jsx)("label",{className:"block text-sm font-bold mb-1 border-primary pr-2",children:"اسم الكتاب"}),(0,r.jsx)(n.Textarea,{required:!0,placeholder:"أدخل اسم الكتاب (أدخل كل اسم في سطر جديد للإضافة المتعددة)",value:h.title,onChange:e=>f({...h,title:e.target.value})})]}),(0,r.jsxs)("div",{className:"col-span-2 md:col-span-1",children:[(0,r.jsx)("label",{className:"block text-sm font-bold mb-1 border-primary pr-2",children:"العدد الكلي المطبوع"}),(0,r.jsx)(n.Input,{type:"number",required:!0,value:h.total_printed,onChange:e=>f({...h,total_printed:e.target.value})})]}),(0,r.jsxs)("div",{className:"col-span-2 md:col-span-1",children:[(0,r.jsx)("label",{className:"block text-sm font-bold mb-1 border-primary pr-2",children:"سعر النسخة"}),(0,r.jsx)(n.Input,{type:"number",step:"0.01",required:!0,value:h.unit_price,onChange:e=>f({...h,unit_price:e.target.value})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 border-t pt-4 border-gray-100 bg-gray-50/50 p-4 rounded-xl",children:[(0,r.jsx)("p",{className:"col-span-2 text-xs font-black text-primary/40 uppercase tracking-widest mb-2",children:"أرصدة افتتاحية (يدوي)"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-bold mb-1 text-muted-foreground",children:"مرسل للمؤسسة"}),(0,r.jsx)(n.Input,{type:"number",value:h.sent_to_institution,onChange:e=>f({...h,sent_to_institution:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-bold mb-1 text-muted-foreground",children:"طور البيع (قم)"}),(0,r.jsx)(n.Input,{type:"number",value:h.qom_pending_manual,onChange:e=>f({...h,qom_pending_manual:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-bold mb-1 text-muted-foreground",children:"مباع (قم)"}),(0,r.jsx)(n.Input,{type:"number",value:h.qom_sold_manual,onChange:e=>f({...h,qom_sold_manual:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-bold mb-1 text-muted-foreground",children:"مهدى (قم)"}),(0,r.jsx)(n.Input,{type:"number",value:h.qom_gifted_manual,onChange:e=>f({...h,qom_gifted_manual:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-bold mb-1 text-muted-foreground",children:"مفقود (يدوي)"}),(0,r.jsx)(n.Input,{type:"number",value:h.loss_manual,onChange:e=>f({...h,loss_manual:e.target.value})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm mb-1 font-bold border-primary pr-2",children:"ملاحظات"}),(0,r.jsx)(n.Textarea,{placeholder:"ملاحظات إضافية...",rows:3,value:h.notes,onChange:e=>f({...h,notes:e.target.value})})]}),(0,r.jsx)(n.Button,{type:"submit",className:"w-full h-12 text-lg shadow-lg",children:"حفظ الكتاب"})]})})]})}e.i(22016),e.s(["default",()=>i])}]);